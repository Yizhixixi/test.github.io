---
layout: post
category: java
title: ï¼ˆææ€•æ˜¯ï¼‰å†™å¾—æœ€é€šä¿—æ˜“æ‡‚çš„ä¸€ç¯‡å…³äºHashMapçš„æ–‡ç« â€”â€”è…¾è®¯çš„å¤§ä½¬è¿™æ ·è¯´
tagline: by æ²‰é»˜ç‹äºŒ
tags: 
  - java
---

>å…ˆçœ‹å†ç‚¹èµï¼Œç»™è‡ªå·±ä¸€ç‚¹æ€è€ƒçš„æ—¶é—´ï¼Œå¾®ä¿¡æœç´¢ã€**æ²‰é»˜ç‹äºŒ**ã€‘å…³æ³¨è¿™ä¸ªæœ‰é¢œå€¼å´å‡è£…é æ‰åè‹Ÿä¸”çš„ç¨‹åºå‘˜ã€‚
>æœ¬æ–‡Â **GitHub**Â [github.com/itwanger](https://github.com/itwanger/itwanger.github.io)Â å·²æ”¶å½•ï¼Œé‡Œé¢è¿˜æœ‰ä¸€çº¿å¤§å‚æ•´ç†çš„é¢è¯•é¢˜ï¼Œä»¥åŠæˆ‘çš„ç³»åˆ—æ–‡ç« ã€‚

<!--more-->


List ç³»åˆ—å·®ä¸å¤šå†™å®Œäº†ï¼Œ å•çº¿ç¨‹ç¯å¢ƒä¸‹æœ€é‡è¦çš„å°±æ˜¯ [ArrayList](https://mp.weixin.qq.com/s/9of-ZgM3FGMkg3g4t7Mq4w) å’Œ [LinkedList](https://mp.weixin.qq.com/s/Gr1kXieJoQol2WuFuHWQaA)ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹æœ€é‡è¦çš„å°±æ˜¯ [CopyOnWriteArrayList](https://mp.weixin.qq.com/s/Z_ZM9D7sNftF3YCEgotJNQ)ï¼Œæ–°æ¥çš„åŒå­¦å¯ä»¥ç‚¹å‡»é“¾æ¥å›é¡¾ä¸€ä¸‹ List çš„çŸ¥è¯†ç‚¹ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘è¦å¸¦ç€ HashMap å»çˆ¬å±±äº†ï¼Œæ³¨æ„ä¸æ˜¯å…­å³°å±±ï¼Œçº¯ç²¹å°±æ˜¯ä¸ºäº†é”»ç‚¼äº†ä¸€ä¸‹èº«ä½“ï¼Œä¸ä¸ä¸ï¼Œçº¯ç²¹æ˜¯ä¸ºäº†å’Œ HashMap æ‹‰è¿‘å…³ç³»ï¼ŒåŒå­¦ä»¬æ³¨æ„ä¸è¦æ‰é˜Ÿã€‚

![](http://www.itwanger.com/assets/images/2020/08/java-hashmap-01.png)


è¯´ä¸€å¥å¾ˆåºŸçš„è¯ï¼ŒHashMap æ˜¯ä¸€ä¸ª Mapï¼Œç”¨æ¥å­˜å‚¨ key-value çš„é”®å€¼å¯¹ï¼Œæ¯ä¸ªé”®éƒ½å¯ä»¥ç²¾ç¡®åœ°æ˜ å°„åˆ°ä¸€ä¸ªå€¼ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªé”®å¿«é€Ÿåœ°æ‰¾åˆ°å¯¹åº”çš„å€¼ã€‚

å¯¹äºä¸€ä¸ª List æ¥è¯´ï¼Œå¦‚æœè¦æ‰¾åˆ°ä¸€ä¸ªå€¼ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º $O(n)$ï¼Œå¦‚æœ List æ’åºè¿‡çš„è¯ï¼Œæ—¶é—´å¤æ‚åº¦å¯ä»¥é™ä½åˆ° $O(log n)$ï¼ˆäºŒåˆ†æŸ¥æ‰¾æ³•ï¼‰ï¼Œä½†å¦‚æœæ˜¯ Map çš„è¯ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ—¶é—´å¤æ‚åº¦èƒ½å¤Ÿé™ä½åˆ° $O(1)$ã€‚

æ¥çœ‹ä¸€ä¸‹ HashMap çš„ç‰¹ç‚¹ï¼š

- HashMap çš„é”®å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œä¸èƒ½é‡å¤ã€‚

- HashMap çš„é”®å…è®¸ä¸º nullï¼Œä½†åªèƒ½æœ‰ä¸€ä¸ªè¿™æ ·çš„é”®ï¼›å€¼å¯ä»¥æœ‰å¤šä¸ª nullã€‚

- HashMap æ˜¯æ— åºçš„ï¼Œå®ƒä¸ä¿è¯å…ƒç´ çš„ä»»ä½•ç‰¹å®šé¡ºåºã€‚

- HashMap ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼›å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå»ºè®®ä½¿ç”¨ ConcurrentHashMapï¼Œæˆ–è€…ä½¿ç”¨ `Collections.synchronizedMap(hashMap)` å°† HashMap è½¬æˆçº¿ç¨‹åŒæ­¥çš„ã€‚

- åªèƒ½ä½¿ç”¨å…³è”çš„é”®æ¥è·å–å€¼ã€‚

- HashMap åªèƒ½å­˜å‚¨å¯¹è±¡ï¼Œæ‰€ä»¥åŸºæœ¬æ•°æ®ç±»å‹åº”è¯¥ä½¿ç”¨å…¶åŒ…è£…å™¨ç±»å‹ï¼Œæ¯”å¦‚è¯´ int åº”è¯¥ä¸º Integerã€‚

- HashMap å®ç°äº† Cloneable å’Œ Serializable æ¥å£ï¼Œå› æ­¤å¯ä»¥æ‹·è´å’Œåºåˆ—åŒ–ã€‚

### 01ã€HashMap çš„é‡è¦å­—æ®µ

 HashMap æœ‰ 5 ä¸ªéå¸¸é‡è¦çš„å­—æ®µï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹ã€‚ï¼ˆJDK ç‰ˆæœ¬ä¸º 14ï¼‰

```java
transient Node<K,V>[] table;
transient int size;
transient int modCount;
int threshold;
final float loadFactor;
```

1ï¼‰table æ˜¯ä¸€ä¸ª Node ç±»å‹çš„æ•°ç»„ï¼Œé»˜è®¤é•¿åº¦ä¸º 16ï¼Œåœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œ `resize()` æ–¹æ³•çš„æ—¶å€™åˆå§‹åŒ–ã€‚

```java
static final int DEFAULT_INITIAL_CAPACITY = 1 << 4; // aka 16
final HashMap.Node<K,V>[] resize() {
    newCap = DEFAULT_INITIAL_CAPACITY;
    Node<K,V>[] newTab = (Node<K,V>[])new Node[newCap];
}
```

Node æ˜¯ HashMap çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œå®ç°äº† Map.Entry æ¥å£ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé”®å€¼å¯¹ã€‚

```java
static class Node<K,V> implements Map.Entry<K,V> {
    final int hash;
    final K key;
    V value;
    HashMap.Node<K,V> next;

    Node(int hash, K key, V value, HashMap.Node<K,V> next) {
        ...
    }

    public final K getKey()        { return key; }
    public final V getValue()      { return value; }
    public final String toString() { return key + "=" + value; }

    public final int hashCode() {
        ...
    }

    public final V setValue(V newValue) {
        ...
    }

    public final boolean equals(Object o) {
        ...
    }
}
```

2ï¼‰size å°±æ˜¯ HashMap ä¸­å®é™…å­˜å‚¨çš„é”®å€¼å¯¹æ•°é‡ï¼Œå®ƒå’Œ table çš„ length æ˜¯æœ‰åŒºåˆ«çš„ã€‚

ä¸ºäº†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š

```java
HashMap<String,Integer> map = new HashMap<>();
map.put("1", 1);
```

å£°æ˜ä¸€ä¸ª HashMapï¼Œç„¶å put ä¸€ä¸ªé”®å€¼å¯¹ã€‚åœ¨ `put()` æ–¹æ³•å¤„æ‰“ä¸€ä¸ªæ–­ç‚¹åè¿›å…¥ï¼Œç­‰åˆ°è¯¥æ–¹æ³•ä¸´è¿‘ç»“æŸçš„æ—¶å€™åŠ ä¸€ä¸ª watchï¼ˆ`table.length`ï¼‰ï¼Œç„¶åå°±å¯ä»¥è§‚å¯Ÿåˆ°å¦‚ä¸‹ç»“æœã€‚

![](http://www.itwanger.com/assets/images/2020/08/java-hashmap-02.png)


ä¹Ÿå°±æ˜¯è¯´ï¼Œæ•°ç»„çš„å¤§å°ä¸º 16ï¼Œä½† HashMap çš„å¤§å°ä¸º 1ã€‚

3ï¼‰modCount ä¸»è¦ç”¨æ¥è®°å½• HashMap å®é™…æ“ä½œçš„æ¬¡æ•°ï¼Œä»¥ä¾¿è¿­ä»£å™¨åœ¨æ‰§è¡Œ `remove()` ç­‰æ“ä½œçš„æ—¶å€™å¿«é€ŸæŠ›å‡º ConcurrentModificationExceptionï¼Œå› ä¸º HashMap å’Œ ArrayList ä¸€æ ·ï¼Œä¹Ÿæ˜¯ fail-fast çš„ã€‚

å…³äº ConcurrentModificationException çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥æŸ¥çœ‹ 03 å°èŠ‚çš„å†…å®¹ã€‚

[]()

4ï¼‰threshold ç”¨æ¥åˆ¤æ–­ HashMap æ‰€èƒ½å®¹çº³çš„æœ€å¤§é”®å€¼å¯¹æ•°é‡ï¼Œå®ƒçš„å€¼ç­‰äºæ•°ç»„å¤§å° * è´Ÿè½½å› å­ã€‚é»˜è®¤æƒ…å†µä¸‹ä¸º 12ï¼ˆ16 * 0.75ï¼‰ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œ `resize()` æ–¹æ³•çš„æ—¶å€™ã€‚

```java
static final int DEFAULT_INITIAL_CAPACITY = 1 << 4; // aka 16
static final float DEFAULT_LOAD_FACTOR = 0.75f;

final HashMap.Node<K,V>[] resize() {
    newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);
}
```

5ï¼‰loadFactor ä¸ºè´Ÿè½½å› å­ï¼Œé»˜è®¤çš„ 0.75 æ˜¯å¯¹ç©ºé—´å’Œæ—¶é—´æ•ˆç‡ä¸Šçš„ä¸€ä¸ªå¹³è¡¡é€‰æ‹©ï¼Œä¸€èˆ¬ä¸å»ºè®®ä¿®æ”¹ï¼Œåƒæˆ‘è¿™ç§å·¥ä½œäº†åå¤šå¹´çš„è€èœé¸Ÿï¼Œå°±ä»æ¥æ²¡æœ‰ä¿®æ”¹è¿‡è¿™ä¸ªå€¼ã€‚

### 02ã€HashMap çš„ hash ç®—æ³•

Hashï¼Œä¸€èˆ¬è¯‘ä½œâ€œæ•£åˆ—â€ï¼Œä¹Ÿæœ‰ç›´æ¥éŸ³è¯‘ä¸ºâ€œå“ˆå¸Œâ€çš„ï¼Œè¿™ç©æ„ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå°±æ˜¯æŠŠä»»æ„é•¿åº¦çš„æ•°æ®é€šè¿‡ä¸€ç§ç®—æ³•æ˜ å°„åˆ°å›ºå®šé•¿åº¦çš„åŸŸä¸Šï¼ˆæ•£åˆ—å€¼ï¼‰ã€‚ 

å†ç›´è§‚ä¸€ç‚¹ï¼Œå°±æ˜¯å¯¹ä¸€ä¸²æ•°æ® wang è¿›è¡Œæ‚ç³…ï¼Œè¾“å‡ºå¦å¤–ä¸€æ®µå›ºå®šé•¿åº¦çš„æ•°æ® erâ€”â€”ä½œä¸ºæ•°æ® wang çš„ç‰¹å¾ã€‚æˆ‘ä»¬é€šå¸¸ç”¨ä¸€ä¸²æŒ‡çº¹æ¥æ˜ å°„æŸä¸€ä¸ªäººï¼Œåˆ«å°ç§æ‰‹æŒ‡å¤´é‚£ä¹ˆå¤§ç‚¹çš„æŒ‡çº¹ï¼Œåœ¨ä½ æ‰€å¤„çš„èŒƒå›´å†…å¾ˆéš¾æ‰¾å‡ºç¬¬äºŒä¸ªå’Œä½ ç›¸åŒçš„ï¼ˆäººçš„æ•£åˆ—ç®—æ³•ä¹Ÿå¥½å‰å®³ï¼Œæœ‰æ²¡æœ‰ï¼Ÿï¼‰ã€‚

å¯¹äºä»»æ„ä¸¤ä¸ªä¸åŒçš„æ•°æ®å—ï¼Œå…¶æ•£åˆ—å€¼ç›¸åŒçš„å¯èƒ½æ€§æå°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºä¸€ä¸ªç»™å®šçš„æ•°æ®å—ï¼Œæ‰¾åˆ°å’Œå®ƒæ•£åˆ—å€¼ç›¸åŒçš„æ•°æ®å—æä¸ºå›°éš¾ã€‚å†è€…ï¼Œå¯¹äºä¸€ä¸ªæ•°æ®å—ï¼Œå“ªæ€•åªæ”¹åŠ¨å®ƒçš„ä¸€ä¸ªæ¯”ç‰¹ä½ï¼Œå…¶æ•£åˆ—å€¼çš„æ”¹åŠ¨ä¹Ÿä¼šéå¸¸çš„å¤§â€”â€”è¿™æ­£æ˜¯ Hash å­˜åœ¨çš„ä»·å€¼ï¼

åŒå­¦ä»¬å·²ç»çŸ¥é“äº†ï¼ŒHashMap çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé‚£ä¸ç®¡æ˜¯å¢åŠ ã€åˆ é™¤ï¼Œè¿˜æ˜¯æŸ¥æ‰¾é”®å€¼å¯¹ï¼Œå®šä½åˆ°æ•°ç»„çš„ä¸‹æ ‡éå¸¸å…³é”®ã€‚

é‚£ HashMap æ˜¯é€šè¿‡ä»€ä¹ˆæ ·çš„æ–¹æ³•æ¥å®šä½ä¸‹æ ‡å‘¢ï¼Ÿ

ç¬¬ä¸€æ­¥ï¼Œ`hash()` æ–¹æ³•ï¼š

```java
static final int hash(Object key) {
    int h;
    return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```

ç¬¬äºŒæ­¥ï¼Œ`putVal()` æ–¹æ³•ä¸­çš„ä¸€è¡Œä»£ç ï¼š

```java
n = (tab = resize()).length;
i = (n - 1) & hash;
```

ä¸ºäº†æ›´å®¹æ˜“ç†è§£ï¼Œæˆ‘æŠŠè¿™ä¸¤æ­¥çš„æ–¹æ³•åˆå¹¶åˆ°äº†ä¸€èµ·ï¼š

```java
String [] keys = {"æ²‰","é»˜","ç‹","äºŒ"};
for (String k : keys) {
    int hasCode = k.hashCode();
    int right = hasCode >>> 16;
    int hash = hasCode ^ right;
    int i = (16 - 1) & hash;
    System.out.println(hash + " ä¸‹æ ‡ï¼š" + i);
}
```

1ï¼‰`k.hashCode()` ç”¨æ¥è®¡ç®—é”®çš„ hashCode å€¼ã€‚å¯¹äºä»»æ„ç»™å®šçš„å¯¹è±¡ï¼Œåªè¦å®ƒçš„ `hashCode()` è¿”å›å€¼æ˜¯ç›¸åŒï¼Œé‚£ä¹ˆ `hash()` æ–¹æ³•è®¡ç®—å¾—åˆ°çš„ Hash ç å°±æ€»æ˜¯ç›¸åŒçš„ã€‚

è¦èƒ½å¤Ÿåšåˆ°è¿™ä¸€ç‚¹ï¼Œå°±è¦æ±‚ä½œä¸ºé”®çš„å¯¹è±¡å¿…é¡»æ˜¯ä¸å¯å˜çš„ï¼Œå¹¶ä¸” `hashCode()` æ–¹æ³•è¦è¶³å¤Ÿçš„å·§å¦™ï¼Œèƒ½å¤Ÿæœ€å¤§å¯èƒ½è¿”å›ä¸é‡å¤çš„ hashCode å€¼ï¼Œæ¯”å¦‚è¯´ String ç±»ã€‚

```java
public int hashCode() {
    int h = hash;
    if (h == 0 && value.length > 0) {
        char val[] = value;

        for (int i = 0; i < value.length; i++) {
            h = 31 * h + val[i];
        }
        hash = h;
    }
    return h;
}
```

2ï¼‰`>>>` ä¸ºæ— ç¬¦å·å³ç§»è¿ç®—ç¬¦ï¼Œé«˜ä½è¡¥ 0ï¼Œç§»å¤šå°‘ä½è¡¥å¤šå°‘ä¸ª 0ã€‚

3ï¼‰`^` ä¸ºå¼‚æˆ–è¿ç®—ç¬¦ï¼Œå…¶è¿ç®—è§„åˆ™ä¸º 1^0 = 1ã€1^1 = 0ã€0^1 = 1ã€0^0 = 0ã€‚

4ï¼‰`&` ä¸ºæŒ‰ä½ä¸è¿ç®—ç¬¦ï¼Œè¿ç®—è§„åˆ™æ˜¯å°†ä¸¤è¾¹çš„æ•°è½¬æ¢ä¸ºäºŒè¿›åˆ¶ä½ï¼Œç„¶åè¿ç®—æœ€ç»ˆå€¼ï¼Œè¿ç®—è§„åˆ™å³ï¼ˆä¸¤ä¸ªä¸ºçœŸæ‰ä¸ºçœŸï¼‰1&1=1ã€1&0=0ã€0&1=0ã€0&0=0ã€‚

å…³äº `>>>`ã€`^`ã€`&` è¿ç®—ç¬¦ï¼Œæ¶‰åŠåˆ°äºŒè¿›åˆ¶ï¼Œæœ¬ç¯‡æ–‡ç« ä¸å†æ·±å…¥ç ”ç©¶ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œç ”ç©¶ä¸€ä¸‹ã€‚

å‡å¦‚å››ä¸ªå­—ç¬¦ä¸²åˆ†åˆ«æ˜¯"æ²‰","é»˜","ç‹","äºŒ"ï¼Œå®ƒä»¬é€šè¿‡ `hash()` æ–¹æ³•è®¡ç®—åå€¼å’Œä¸‹æ ‡å¦‚ä¸‹æ‰€ç¤ºï¼š

```
27785 ä¸‹æ ‡ï¼š9
40664 ä¸‹æ ‡ï¼š8
29579 ä¸‹æ ‡ï¼š11
20108 ä¸‹æ ‡ï¼š12
```

åº”è¯¥è¯´ï¼Œè¿™æ ·çš„ hash ç®—æ³•éå¸¸å·§å¦™ï¼Œå°¤å…¶æ˜¯ç¬¬äºŒæ­¥ã€‚

>HashMap åº•å±‚æ•°ç»„çš„é•¿åº¦æ€»æ˜¯ 2 çš„ n æ¬¡æ–¹ï¼Œå½“ length æ€»æ˜¯ 2 çš„ n æ¬¡æ–¹æ—¶ï¼Œ`(length - 1) & hash` è¿ç®—ç­‰ä»·äºå¯¹æ•°ç»„çš„é•¿åº¦å–æ¨¡ï¼Œä¹Ÿå°±æ˜¯ `hash%length`ï¼Œä½†æ˜¯ & æ¯” % å…·æœ‰æ›´é«˜çš„æ•ˆç‡ã€‚

### 03ã€HashMap çš„ `put()` æ–¹æ³•

HashMap çš„ hash ç®—æ³•æˆ‘ä»¬æ˜¯æ˜ç™½äº†ï¼Œä½†ä¼¼ä¹æœ‰ä¸€ä¸ç–‘è™‘ï¼Œå°±æ˜¯ä¸‡ä¸€è®¡ç®—åçš„ hash å€¼å†²çªäº†æ€ä¹ˆåŠï¼Ÿ

æ¯”å¦‚è¯´ï¼Œâ€œæ²‰Xâ€è®¡ç®—åçš„ hash å€¼ä¸º 27785ï¼Œå…¶ä¸‹æ ‡ä¸º 9ï¼Œæ”¾åœ¨äº†æ•°ç»„ä¸‹æ ‡ä¸º 9 çš„ä½ç½®ä¸Šï¼›è¿‡äº†ä¸€ä¼šï¼Œåˆæ¥ä¸ªâ€œæ²‰Yâ€è®¡ç®—åçš„ hash å€¼ä¹Ÿä¸º 27785ï¼Œä¸‹æ ‡ä¹Ÿä¸º 9ï¼Œä¹Ÿéœ€è¦æ”¾åœ¨ä¸‹æ ‡ä¸º 9 çš„ä½ç½®ä¸Šï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ

ä¸ºäº†æ¨¡æ‹Ÿè¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬æ¥æ–°å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„é”®ç±»ã€‚

```java
public class Key {
    private final String value;

    public Key(String value) {
        this.value = value;
    }
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass())
            return false;
        Key key = (Key) o;
        return value.equals(key.value);
    }

    @Override
    public int hashCode() {
        if (value.startsWith("æ²‰")) {
            return "æ²‰".hashCode();
        }
        return value.hashCode();
    }
}
```

åœ¨ `hashCode()` æ–¹æ³•ä¸­ï¼ŒåŠ äº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœé”®æ˜¯ä»¥â€œæ²‰â€å¼€å¤´çš„è¯ï¼Œå°±è¿”å›â€œæ²‰â€çš„ hashCode å€¼ï¼Œè¿™å°±æ„å‘³ç€â€œæ²‰Xâ€å’Œâ€œæ²‰Yâ€å°†ä¼šå‡ºç°åœ¨æ•°ç»„çš„åŒä¸€ä¸ªä¸‹æ ‡ä¸Šã€‚

```java
HashMap<Key,String> map = new HashMap<>();
map.put(new Key("æ²‰X"),"æ²‰é»˜ç‹äºŒX");
map.put(new Key("æ²‰Y"),"æ²‰é»˜ç‹äºŒY");
```

é‚£ç´§æ¥ç€æ¥çœ‹ä¸€ä¸‹ `put()` æ–¹æ³•çš„æºç ï¼š

```java
public V put(K key, V value) {
    return putVal(hash(key), key, value, false, true);
}
```

`put()` æ–¹æ³•ä¼šå…ˆè°ƒç”¨ `hash()` æ–¹æ³•è®¡ç®— key çš„ hash å€¼ï¼Œç„¶åå†è°ƒç”¨å†…éƒ¨æ–¹æ³• `putVal()`ï¼š

```java
final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
               boolean evict) {
    HashMap.Node<K,V>[] tab; HashMap.Node<K,V> p; int n, i;
    // â‘ ã€æ•°ç»„ table ä¸º null æ—¶ï¼Œè°ƒç”¨ resize æ–¹æ³•åˆ›å»ºé»˜è®¤å¤§å°çš„æ•°ç»„
    if ((tab = table) == null || (n = tab.length) == 0)
        n = (tab = resize()).length;
    // â‘¡ã€è®¡ç®—ä¸‹æ ‡ï¼Œå¦‚æœè¯¥ä½ç½®ä¸Šæ²¡æœ‰å€¼ï¼Œåˆ™å¡«å……
    if ((p = tab[i = (n - 1) & hash]) == null)
        tab[i] = newNode(hash, key, value, null);
    else {
        HashMap.Node<K,V> e; K k;
        // â‘¢ã€å¦‚æœé”®å·²ç»å­˜åœ¨äº†ï¼Œå¹¶ä¸” hash å€¼ç›¸åŒï¼Œç›´æ¥è¦†ç›–
        if (p.hash == hash &&
                ((k = p.key) == key || (key != null && key.equals(k))))
            e = p;
        // â‘£ã€çº¢é»‘æ ‘å¤„ç†
        else if (p instanceof HashMap.TreeNode)
            e = ((HashMap.TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);
        else {
            // â‘¤ã€å¢åŠ é“¾è¡¨æ¥å¤„ç†å“ˆå¸Œå†²çª
            for (int binCount = 0; ; ++binCount) {
                if ((e = p.next) == null) {
                    p.next = newNode(hash, key, value, null);
                    // å¦‚æœé“¾è¡¨é•¿åº¦å¤§äº 8 è½¬æ¢ä¸ºçº¢é»‘æ ‘å¤„ç†
                    if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st
                        treeifyBin(tab, hash);
                    break;
                }
                // å¦‚æœé”®å·²ç»å­˜åœ¨äº†ï¼Œå¹¶ä¸” hash å€¼ç›¸åŒï¼Œç›´æ¥è¦†ç›–
                if (e.hash == hash &&
                        ((k = e.key) == key || (key != null && key.equals(k))))
                    break;
                p = e;
            }
        }
        if (e != null) { // existing mapping for key
            V oldValue = e.value;
            if (!onlyIfAbsent || oldValue == null)
                e.value = value;
            afterNodeAccess(e);
            return oldValue;
        }
    }
    ++modCount;
    // â‘¥ã€è¶…è¿‡å®¹é‡é™åˆ¶ï¼Œæ‰©å®¹
    if (++size > threshold)
        resize();
    afterNodeInsertion(evict);
    return null;
}
```

ä»£ç é‡Œæˆ‘åŠ äº†ä¸€äº›æ³¨é‡Šï¼ŒåŒå­¦ä»¬ä¸€å®šè¦èŠ±ç‚¹æ—¶é—´çœ‹ä¸€ä¸‹ã€‚

å¦‚æœå“ˆå¸Œå†²çªçš„è¯ï¼Œä¼šæ‰§è¡Œ â‘¡ å¤„å¯¹åº”çš„ else è¯­å¥ï¼Œå…ˆåˆ¤æ–­é”®æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰çš„è¯ç›´æ¥è¦†ç›–ï¼›å¦åˆ™æ‰§è¡Œ â‘£ï¼Œåšçº¢é»‘æ ‘å¤„ç†ï¼›å¦‚æœä¸æ˜¯ï¼Œä¼šæ‰§è¡Œ â‘¤ï¼ŒæŠŠä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„ next èµ‹å€¼ä¸ºæ–°çš„ Nodeã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå“ˆå¸Œå†²çªäº†ï¼Œä¼šåœ¨æ•°ç»„çš„åŒä¸€ä¸ªä½ç½®ä¸Šå¢åŠ é“¾è¡¨ï¼Œå¦‚æœé“¾è¡¨çš„é•¿åº¦å¤§äº 8ï¼Œå°†ä¼šè½¬åŒ–æˆçº¢é»‘æ ‘è¿›è¡Œå¤„ç†ã€‚

![](http://www.itwanger.com/assets/images/2020/08/java-hashmap-03.png)


ä»¥ä¸Šå°±æ˜¯å¤§ç‰›ä»¬å˜´é‡Œå¸¸è¯´çš„â€œé“¾åœ°å€æ³•â€ï¼Œç®€å•ç‚¹è¯´ï¼Œå°±æ˜¯æ•°ç»„åŠ é“¾è¡¨ï¼Œç”±äºé“¾è¡¨çš„æŸ¥è¯¢æ•ˆç‡æ¯”è¾ƒä½ï¼ˆæ—¶é—´å¤æ‚åº¦ä¸º $O(n)$ï¼‰ï¼ŒJava 8 åˆè¿½åŠ äº†çº¢é»‘æ ‘ï¼ˆæ—¶é—´å¤æ‚åº¦ä¸º $O(log n)$ï¼‰ã€‚

ç•™ä¸ªå°ä½œä¸šå“ˆï¼ŒåŒå­¦ä»¬å¯ä»¥ç ”ç©¶ä¸€ä¸‹ï¼Œå½“é”®ä¸º null çš„æ—¶å€™ï¼Œé”®å€¼å¯¹å­˜æ”¾åœ¨ä»€ä¹ˆä½ç½®ä¸Šï¼Ÿ

### 04ã€HashMap çš„ `get()` æ–¹æ³•

ç†è§£äº† HashMap çš„ hash ç®—æ³•å’Œ `put()` æ–¹æ³•ï¼Œ`get()` æ–¹æ³•å°±å¾ˆå®¹æ˜“ç†è§£ã€‚

```java
public V get(Object key) {
    HashMap.Node<K,V> e;
    return (e = getNode(hash(key), key)) == null ? null : e.value;
}
```

é¦–å…ˆè®¡ç®— key çš„ hash å€¼ï¼Œå½“ hash å€¼ç¡®å®šåï¼Œé”®å€¼å¯¹åœ¨æ•°ç»„ä¸­çš„ä¸‹æ ‡ä½ç½®ä¹Ÿå°±ç¡®å®šäº†ï¼Œç„¶åå†è°ƒç”¨ `getNode()` æ–¹æ³•ï¼š

```java
final HashMap.Node<K,V> getNode(int hash, Object key) {
    HashMap.Node<K,V>[] tab; HashMap.Node<K,V> first, e; int n; K k;
    if ((tab = table) != null && (n = tab.length) > 0 &&
            (first = tab[(n - 1) & hash]) != null) {
        if (first.hash == hash && // always check first node
                ((k = first.key) == key || (key != null && key.equals(k))))
            return first;
        if ((e = first.next) != null) {
            if (first instanceof HashMap.TreeNode)
                return ((HashMap.TreeNode<K,V>)first).getTreeNode(hash, key);
            do {
                if (e.hash == hash &&
                        ((k = e.key) == key || (key != null && key.equals(k))))
                    return e;
            } while ((e = e.next) != null);
        }
    }
    return null;
}
```

å…¶ä¸­ `first = tab[(n - 1) & hash]` å°±å¯ä»¥å¿«é€Ÿçš„ç¡®å®šé”®å¯¹åº”çš„å€¼ï¼Œå¦‚æœé”®ç›¸ç­‰å¹¶ä¸”é”®çš„ hash ç›¸ç­‰ï¼Œåˆ™ç›´æ¥è¿”å›ï¼›å¦‚æœé”®çš„å“ˆå¸Œå†²çªäº†ï¼Œå°±å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯çº¢é»‘æ ‘ï¼Œä¸æ˜¯çš„è¯å°±éå†é“¾è¡¨ã€‚

### 05ã€æœ€å

è¯´å¥å®åœ¨è¯ï¼Œåœ¨å†™è¿™ç¯‡æ–‡ç« ä¹‹å‰ï¼Œæˆ‘å¯¹ HashMap çš„è®¤çŸ¥å¹¶æ²¡æœ‰è¿™ä¹ˆæ·±åˆ»ï¼Œä½†å†™å®Œè¿™ç¯‡æ–‡ç« åï¼Œæˆ‘æ•¢æ‹ç€èƒ¸è„¯ä¿¡èª“æ—¦æ—¦åœ°è¯´ï¼šâ€œHashMap æˆ‘çœŸçš„æŒæ¡äº†ï¼ŒåŒå­¦ä»¬è°ä»¥åå†é—®æˆ‘ï¼Œå°±å¯ä»¥æŠŠè¿™ç¯‡æ–‡ç« ç”©ç»™ä»–äº†ã€‚â€

è¿™æ¬¡çˆ¬å±±è™½ç„¶å¾ˆç´¯ï¼Œä½†ç¡®å®æ”¶è·å¾ˆå¤§ï¼Œå€¼äº†ï¼

-----

æˆ‘æ˜¯æ²‰é»˜ç‹äºŒï¼Œä¸€æšæœ‰é¢œå€¼å´å‡è£…é æ‰åè‹Ÿä¸”çš„ç¨‹åºå‘˜ã€‚**å…³æ³¨å³å¯æå‡å­¦ä¹ æ•ˆç‡ï¼Œåˆ«å¿˜äº†ä¸‰è¿å•Šï¼Œç‚¹èµã€æ”¶è—ã€ç•™è¨€ï¼Œæˆ‘ä¸æŒ‘ï¼Œå¥¥åˆ©ç»™ğŸŒ¹**ã€‚

æ³¨ï¼šå¦‚æœæ–‡ç« æœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿æ¯«ä¸ç•™æƒ…åœ°æŒ‡æ­£ã€‚

å¦‚æœä½ è§‰å¾—æ–‡ç« å¯¹ä½ æœ‰äº›å¸®åŠ©ï¼Œæ¬¢è¿å¾®ä¿¡æœç´¢ã€Œ**æ²‰é»˜ç‹äºŒ**ã€ç¬¬ä¸€æ—¶é—´é˜…è¯»ï¼Œå›å¤å…³é”®å­—ã€Œ**å°ç™½**ã€å¯ä»¥å…è´¹è·å–æˆ‘è‚äº† 4 ä¸‡+å­—çš„ ã€ŠJava å°ç™½ä»å…¥é—¨åˆ°æ”¾è‚†ã€‹2.0 ç‰ˆï¼›æœ¬æ–‡Â **GitHub**Â [github.com/itwanger](https://github.com/itwanger/itwanger.github.io)Â å·²æ”¶å½•ï¼Œæ¬¢è¿ starã€‚